# Асинхронный телеграм бот (aiogram)
### Приложение состоит из трёх частей:
1. телеграмм бот который рассказывает анекдоты по предложенному слову или словосочетанию. После того как пользователь получил анекдот ему предлагается его оценить. Бот работает на вебхуках. @anecdot_searcher_bot

2. сайт на котором находятся оцененные пользователем анекдоты. Это Flask приложение с очень простым интерфейсом (только анекдоты, навигация по страницам с рейтингом и кнопка для админки). Есть пять страничек, соответствующих рейтингу 1-5, на каждой по 9 анекдотов. Можно зайти и посмотреть введя ссылку в браузере, но этот способ не позволит попасть в админку т.к не содержит chat id из телеграмм. Чтобы он появился нужно оценить анекдот в телеграмме и перейти по предложенной ссылке. Ссылка для примера (рабочая, но без возможности регистрации) первое число это рэйтинг анекдотов, второе chat id пользователя из телеграмма. http://anecdoter.su/rating/5/1

3. стандартная Flask админка поддерживающаю CRUD операции для пользователя с правами админа.  

# Основные технологии:

### Python

### Docker

### PostgrSQL

### Flask

### SQLAlchemy

### aiogram

### BeautifulSoup 

Приложение упаковано в докер. Реализовано кеширование данных, текст анекдота выдаваемый телеграммом находится в ф-ции генераторе, которая хранится в кеше юзера, в базе хранятся только индексы - порядковый номер анекдота на странице и номер страницы с www.anekdot.ru. Сайт (веб приложение) работает с моделью, в которой всегда 45 анекдотов - это анекдоты оценённые пользователем, каждая новая оценка вытесняет один анекдот с соответствующим рейтингом.

## Запуск в режиме разработки
1. Клонируем репку, основная ветка aiobot_server
2. Для работы бота потребуется токен, его нужно попросить у BotFather в телеграме
3. Для работы aiogram (на хуках) с локальной машины потребуется ngrok или что у вас там есть. Без заморочек можно запустить telebot. Заходим в docker-compose.yml коментируем то что не нужно, можно запустить сразу два, тогда нужно два токена
4. Запускаем докер, указываем токен для бота, конфиг для сайта, для первого раза придётся собрать

```TOKEN=<токен для aiogram здеся> CONFIG=config.DevelopmentConfig docker-compose up --build ```

5. Чтобы не созадавать пустую базу и потом ее героически заполнять - заливаем дамп в контейнер (не забываем про путь до проэкта)

``` docker exec -i anecdoter_db_1 pg_restore -U root -d anecdoter_db < anecdoter/db_dump/latest.dump.2 ```

6. Сайт будет по адресу http://127.0.0.1:5000, бот там где дали токен
